<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Composition for `Element`s using drm planes"><title>smithay::backend::drm::compositor - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../../../../" data-static-root-path="../../../../static.files/" data-current-crate="smithay" data-themes="" data-resource-suffix="" data-rustdoc-version="1.80.0-nightly (7c52d2db6 2024-06-03)" data-channel="nightly" data-search-js="search-d52510db62a78183.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../../smithay/index.html">smithay</a><span class="version">0.3.0</span></h2></div><h2 class="location"><a href="#">Module compositor</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li></ul></section><h2><a href="../index.html">In smithay::backend::drm</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../../index.html">smithay</a>::<wbr><a href="../../index.html">backend</a>::<wbr><a href="../index.html">drm</a>::<wbr><a class="mod" href="#">compositor</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../../../src/smithay/backend/drm/compositor/mod.rs.html#1-4360">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><span class="item-info"><div class="stab portability">Available on <strong>crate features <code>wayland_frontend</code> and <code>backend_gbm</code> and <code>backend_drm</code></strong> only.</div></span><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Composition for <a href="../../renderer/element/trait.Element.html" title="trait smithay::backend::renderer::element::Element"><code>Element</code></a>s using drm planes</p>
<p>When possible composition can be (partially) offloaded to the display driver by assigning
elements to drm planes. This is especially important for latency intensive fullscreen clients
like video renderers or games.</p>
<p>The <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a> does so by walking the stack of provided <a href="../../renderer/element/trait.Element.html" title="trait smithay::backend::renderer::element::Element"><code>Element</code></a>s from front to back
while trying to assign each element to a drm overlay plane. Each item that fails the plane test
will be rendered on the primary plane using the provided <a href="../../renderer/trait.Renderer.html" title="trait smithay::backend::renderer::Renderer"><code>Renderer</code></a>.
Additionally it will try to assign the top most element that fit’s into the cursor size (as specified
by the <a href="../struct.DrmDevice.html" title="struct smithay::backend::drm::DrmDevice"><code>DrmDevice</code></a>) on the cursor plane. If the element can not be
directly scanned out, pixman will be used to render the element.</p>
<p>Note: While the <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a> also works on <em>legacy</em> drm the use of overlay and cursor planes is disabled in that case.
Direct scan-out will only work with an atomic <a href="../struct.DrmSurface.html" title="struct smithay::backend::drm::DrmSurface"><code>DrmSurface</code></a>.</p>
<h3 id="what-makes-a-element-eligible-for-direct-scan-out"><a class="doc-anchor" href="#what-makes-a-element-eligible-for-direct-scan-out">§</a>What makes a <a href="../../renderer/element/trait.Element.html" title="trait smithay::backend::renderer::element::Element"><code>Element</code></a> eligible for direct scan-out</h3><h4 id="general"><a class="doc-anchor" href="#general">§</a>General</h4>
<p>First the element has to provide a <a href="../../renderer/element/enum.UnderlyingStorage.html" title="enum smithay::backend::renderer::element::UnderlyingStorage"><code>UnderlyingStorage</code></a> which can be exported as a drm framebuffer.
Currently this is limited to wayland buffers, but may be extended in the future.
This module provides a default exporter based on <a href="gbm/index.html" title="mod smithay::backend::drm::compositor::gbm"><code>gbm</code></a> which should fit most use-cases.</p>
<p>If a certain combination of elements works can only be determined by asking the driver by submitting
a atomic commit test. If that test fails the element is scheduled to be rendered on the primary plane.</p>
<h4 id="overlay-planes"><a class="doc-anchor" href="#overlay-planes">§</a>Overlay planes</h4>
<p>The element can only be directly scanned out if it’s geometry does not overlap with an already assigned
element on a plane higher in the stack.</p>
<h4 id="underlay-planes"><a class="doc-anchor" href="#underlay-planes">§</a>Underlay planes</h4>
<p>An underlay plane is only used if it does not overlap with an already assigned plane lower in the stack
and the element is fully opaque.</p>
<h4 id="primary-plane"><a class="doc-anchor" href="#primary-plane">§</a>Primary plane</h4>
<p>For an element to be considered to be directly scanned out on the primary plane it has to be the last remaining
visible element on the output and no other element has been assigned to the primary plane. If there are multiple
element assigned to the primary plane the renderer will be used to composite the primary plane into a allocator
provided buffer. Additionally the element has to be either fully opaque or the clear color has to match the CRTC
background color and no overlap with an underlay is found.</p>
<h2 id="how-to-use-it"><a class="doc-anchor" href="#how-to-use-it">§</a>How to use it</h2>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>smithay::{
    backend::drm::{compositor::DrmCompositor, DrmSurface},
    output::{Output, PhysicalProperties, Subpixel},
    utils::Size,
};

<span class="comment">// ...initialize the output, drm device, drm surface and allocator
</span><span class="kw">let </span>output = Output::new(
    <span class="string">"e-DP"</span>.into(),
    PhysicalProperties {
        size: Size::from((<span class="number">800</span>, <span class="number">600</span>)),
        make: <span class="string">"N/A"</span>.into(),
        model: <span class="string">"N/A"</span>.into(),
        subpixel: Subpixel::Unknown,
    },
);

<span class="kw">let </span><span class="kw-2">mut </span>compositor: DrmCompositor&lt;<span class="kw">_</span>, <span class="kw">_</span>, (), <span class="kw">_</span>&gt; = DrmCompositor::new(
    <span class="kw-2">&amp;</span>output,
    surface,
    <span class="prelude-val">None</span>,
    allocator,
    exporter,
    color_formats,
    renderer_formats,
    device.cursor_size(),
    <span class="prelude-val">Some</span>(gbm),
)
.expect(<span class="string">"failed to initialize drm compositor"</span>);

<span class="kw">let </span>render_frame_result = compositor
    .render_frame::&lt;<span class="kw">_</span>, <span class="kw">_</span>&gt;(<span class="kw-2">&amp;mut </span>renderer, <span class="kw-2">&amp;</span>elements, CLEAR_COLOR)
    .expect(<span class="string">"failed to render frame"</span>);

<span class="kw">if </span>!render_frame_result.is_empty {
    compositor.queue_frame(()).expect(<span class="string">"failed to queue frame"</span>);

    <span class="comment">// ...wait for VBlank event

    </span>compositor
        .frame_submitted()
        .expect(<span class="string">"failed to mark frame as submitted"</span>);
} <span class="kw">else </span>{
    <span class="comment">// ...re-schedule frame
</span>}</code></pre></div>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="dumb/index.html" title="mod smithay::backend::drm::compositor::dumb">dumb</a></div><div class="desc docblock-short">Implementation for ExportFramebuffer and related utilizies for dumb buffers</div></li><li><div class="item-name"><a class="mod" href="gbm/index.html" title="mod smithay::backend::drm::compositor::gbm">gbm</a></div><div class="desc docblock-short">Implementation for ExportFramebuffer and related utilizies for gbm types</div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor">DrmCompositor</a></div><div class="desc docblock-short">Composite an output using a combination of planes and rendering</div></li><li><div class="item-name"><a class="struct" href="struct.PrimarySwapchainElement.html" title="struct smithay::backend::drm::compositor::PrimarySwapchainElement">PrimarySwapchainElement</a></div><div class="desc docblock-short">Defines the element for the primary plane in cases where a composited buffer was used.</div></li><li><div class="item-name"><a class="struct" href="struct.RenderFrameResult.html" title="struct smithay::backend::drm::compositor::RenderFrameResult">RenderFrameResult</a></div><div class="desc docblock-short">Result for <a href="struct.DrmCompositor.html#method.render_frame" title="method smithay::backend::drm::compositor::DrmCompositor::render_frame"><code>DrmCompositor::render_frame</code></a></div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.BlitFrameResultError.html" title="enum smithay::backend::drm::compositor::BlitFrameResultError">BlitFrameResultError</a></div><div class="desc docblock-short">Error for <a href="struct.RenderFrameResult.html#method.blit_frame_result" title="method smithay::backend::drm::compositor::RenderFrameResult::blit_frame_result"><code>RenderFrameResult::blit_frame_result</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.ExportBuffer.html" title="enum smithay::backend::drm::compositor::ExportBuffer">ExportBuffer</a></div><div class="desc docblock-short">Possible buffers to export as a framebuffer using <a href="trait.ExportFramebuffer.html" title="trait smithay::backend::drm::compositor::ExportFramebuffer"><code>ExportFramebuffer</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.FrameError.html" title="enum smithay::backend::drm::compositor::FrameError">FrameError</a></div><div class="desc docblock-short">Errors thrown by a <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.PrimaryPlaneElement.html" title="enum smithay::backend::drm::compositor::PrimaryPlaneElement">PrimaryPlaneElement</a></div><div class="desc docblock-short">Defines the element for the primary plane</div></li><li><div class="item-name"><a class="enum" href="enum.RenderFrameError.html" title="enum smithay::backend::drm::compositor::RenderFrameError">RenderFrameError</a></div><div class="desc docblock-short">Error returned from <a href="struct.DrmCompositor.html#method.render_frame" title="method smithay::backend::drm::compositor::DrmCompositor::render_frame"><code>DrmCompositor::render_frame</code></a></div></li></ul><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.ExportFramebuffer.html" title="trait smithay::backend::drm::compositor::ExportFramebuffer">ExportFramebuffer</a></div><div class="desc docblock-short">Export a <a href="enum.ExportBuffer.html" title="enum smithay::backend::drm::compositor::ExportBuffer"><code>ExportBuffer</code></a> as a framebuffer</div></li></ul></section></div></main></body></html>